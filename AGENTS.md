# Agent instructions (scope: this directory and subdirectories)

This repo is a workflow template for **multi-role, worktree-based collaboration** with **hard isolation** and **auditable Markdown handoffs**.

## Scope and layout
- **This AGENTS.md applies to:** repo root and below.
- **Key directories:**
  - `docs/`: protocol, prompts, and Markdown templates (the "team operating system").
  - `scripts/`: PowerShell automation (`new-session`, `dispatch`, `log-entry`, `check-session`).
  - `sessions/`: runtime session state (ignored by git; do not commit).
  - `.tools/`: local tooling/cache (ignored by git; do not commit).

## Modules / subprojects

| Module | Type | Path | What it owns | How to run | Tests | Docs | AGENTS |
|--------|------|------|--------------|------------|-------|------|--------|
| docs | docs | `docs/` | roles/prompts, protocol, templates | N/A | N/A | `docs/protocol.md`, `docs/team-mode.md` | `docs/AGENTS.md` |
| scripts | powershell | `scripts/` | session automation | `pwsh ./scripts/<script>.ps1 ...` | manual dry-run | `README.md`, `docs/protocol.md` | `scripts/AGENTS.md` |
| sessions | runtime | `sessions/` | per-session shared + per-role mailboxes | generated by scripts | `pwsh ./scripts/check-session.ps1 ...` | `docs/templates/*` | N/A |

## Cross-domain workflow (the core contract)
- The **single source of truth** for a session is `sessions/<id>/shared/*.md`.
- Each role writes only to its mailbox `sessions/<id>/roles/<role>/{inbox,outbox,worklog}.md`.
- Scripts must always resolve to the **main worktree** so all roles read/write the same `sessions/` tree (even when invoked inside a role worktree).

## Team Classification Mode (Claude Code parity)
- Use `docs/team-mode.md` as the routing guide: classify work first, then dispatch to roles.
- Do not start implementing until:
  - `shared/task.md` has **acceptance criteria** (executable verification where possible).
  - A role mailbox has a **task id** (so handoffs can be tracked).

## Verification (preferred commands)
- Session health: `pwsh ./scripts/check-session.ps1 -SessionName <session-id>`
- Create session: `pwsh ./scripts/new-session.ps1 -SessionName <session-id> -CreateWorktrees`
- Dispatch: `pwsh ./scripts/dispatch.ps1 -SessionName <session-id> -Role <role> -Message "<...>" -Acceptance "<...>"`

## Autopilot (mac)
- Unattended multi-role execution: `docs/autopilot-mac.md`
- Start daemons: `./scripts/autopilot.sh start <session-id>`

## Global conventions
- Preserve the isolation model: roles communicate via Markdown, not "memory".
- Prefer small, auditable changes to docs/scripts; every workflow change should update templates/prompts accordingly.
- Keep files ASCII unless the file already contains non-ASCII (current docs include Chinese text; keep it consistent).

## Do not
- Do not add committed content under `sessions/` or `.tools/`.
- Do not weaken role boundaries (e.g., allow Builder-A to read Builder-B private logs).
